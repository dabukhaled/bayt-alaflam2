(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function e(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=e(t);fetch(t.href,s)}})();let i={movies:[],settings:{fullPassword:"5555",familyPassword:"565999",loginPageEnabled:!0,familyMode:!1},currentSection:"all",currentPage:1,itemsPerPage:100,zoomLevel:100,accessMode:"guest"},y=!1,d,m=[],h=!1;document.addEventListener("DOMContentLoaded",()=>{console.log("DOM fully loaded. Attaching events."),N(),B(),O(),F();const a=document.getElementById("loadMoreBtn");a&&a.addEventListener("click",()=>{d&&(a.textContent="جاري التحميل...",a.disabled=!0,d.postMessage({command:"loadNextChunk"}))}),M()});async function M(){const a=localStorage.getItem("app_login");if(a){console.log("Auto-login data found. Initializing application.");try{const n=JSON.parse(a);i.accessMode=n.accessMode,i.accessMode==="family"&&(i.settings.familyMode=!0),await I()}catch(n){console.error("Corrupted auto-login data.",n),localStorage.removeItem("app_login")}}else console.log("No auto-login data. Waiting for user to log in.")}async function I(){if(y){console.log("Application already initialized.");return}y=!0,document.getElementById("loginPage").classList.add("hidden"),document.getElementById("mainApp").classList.remove("hidden"),i.settings.familyMode&&document.querySelectorAll(".category-menu-btn").forEach((n,e)=>{(e===2||e===3)&&(n.style.display="none")}),await _(),L()}function L(){const a=document.getElementById("loadingIndicator"),n=document.getElementById("loadingProgressFill"),e=document.getElementById("loadingProgressText"),o=document.getElementById("loadMoreContainer"),t=document.getElementById("loadMoreBtn");o&&(o.style.display="none"),a.classList.remove("hidden"),n.style.width="0%",e.textContent="بدء التحميل...",d&&d.terminate(),d=new Worker("worker.js"),d.postMessage({command:"start"});let s=[],r=!1;async function l(){if(r||s.length===0)return;r=!0;const c=s.shift();C(c.payload,c.format),c.isFirstBatch&&(f(),v()),await new Promise(u=>setTimeout(u,50)),r=!1,l()}d.onmessage=function(c){const{type:u,payload:g,format:S,isFirstBatch:k}=c.data;switch(u){case"data":s.push({payload:g,format:S,isFirstBatch:k}),l();break;case"settings":i.settings={...i.settings,...g};break;case"progress":if(a.classList.contains("hidden"))return;n.style.width=`${g.progress}%`,e.textContent=g.text;break;case"fallback":console.warn("Worker failed to fetch, falling back to localStorage."),x(),p(),f(),v(),a.classList.add("hidden");break;case"chunkLoaded":console.log(`Chunk ${g.chunkNumber} loaded.`),p(),f(),t&&(t.textContent="تحميل المزيد من النتائج",t.disabled=!1);break;case"done":const w=setInterval(()=>{s.length===0&&!r&&(clearInterval(w),console.log("Worker finished a task. Finalizing UI."),p(),f(),v(),E(),a.classList.contains("hidden")||setTimeout(()=>a.classList.add("hidden"),500),g&&g.allChunksLoaded?(console.log("All chunks have been loaded."),o&&(o.style.display="none"),d&&(d.terminate(),d=null)):(console.log("Initial chunk loaded. More chunks available."),o&&(o.style.display="block"),t&&(t.textContent="تحميل المزيد من النتائج",t.disabled=!1)))},100);break;case"error":console.error("Error from worker:",g),e.textContent="فشل تحميل البيانات!",a.classList.add("hidden"),d&&(d.terminate(),d=null);break}},d.onerror=function(c){console.error("An error occurred in the worker:",c),e.textContent="فشل حاد في أداة التحميل!",a.classList.add("hidden"),d&&(d.terminate(),d=null)}}function C(a,n="default"){a.forEach(e=>{let o;n==="alternate"?o={id:e.id||`movie_${Date.now()}_${Math.random()}`,title:e.name||"بدون عنوان",imageUrl:e.img||"https://via.placeholder.com/200x300?text=No+Image",link:e.href||"#",category:e.category||"all",hidden:e.hidden||!1,site:b(e.href||""),dateAdded:e.dateAdded||e.addedDate||new Date().toISOString(),isFavorite:!!e.star}:o={id:e.movies_id||e.id||`movie_${Date.now()}_${Math.random()}`,title:e.movies_name||e.series_name||e.name||"بدون عنوان",imageUrl:e.movies_img||e.series_img||e.img||"https://via.placeholder.com/200x300?text=No+Image",link:e.movies_href||e.series_href||e.href||"#",category:e.movies_category||e.category||"all",hidden:e.movies_hidden||e.hidden||!1,site:b(e.movies_href||e.series_href||e.href||""),dateAdded:e.dateAdded||e.addedDate||new Date().toISOString(),isFavorite:e.isFavorite||!1},i.movies.find(s=>s.id===o.id)||i.movies.push(o)})}async function x(){await P()}async function P(){if(h||await _(),m.length===0){alert("لم يتم العثور على بيانات احتياطية.");return}let a=0;const n=new Set(i.movies.map(e=>e.id));m.forEach(e=>{n.has(e.id)||(i.movies.push(e),a++)}),a>0?(E(),p(),f(),alert(`تمت إضافة ${a} أفلام جديدة من النسخة الاحتياطية.`)):alert("البيانات محدثة بالفعل. لا توجد أفلام جديدة لإضافتها.")}async function _(){if(h)return;console.log("Loading backup movies from chunks...");const a=["database_chunks/app_database1.json","database_chunks/app_database2.json","database_chunks/app_database3.json","database_chunks/app_database4.json","database_chunks/app_database5.json","database_chunks/app_database6.json"];for(const n of a)try{const e=await fetch(n);if(!e.ok){console.error(`Failed to fetch ${n}: ${e.statusText}`);continue}const o=await e.json();o.movies_info&&o.movies_info.forEach(t=>{const s={id:t.movies_id||t.id||`movie_${Date.now()}_${Math.random()}`,title:t.movies_name||t.series_name||t.name||"بدون عنوان",imageUrl:t.movies_img||t.series_img||t.img||"https://via.placeholder.com/200x300?text=No+Image",link:t.movies_href||t.series_href||t.href||"#",category:t.movies_category||t.category||"all",hidden:t.movies_hidden||t.hidden||!1,site:b(t.movies_href||t.series_href||t.href||""),dateAdded:t.dateAdded||t.addedDate||new Date().toISOString(),isFavorite:t.isFavorite||!1};m.push(s)})}catch(e){console.error(`Error loading or parsing ${n}:`,e)}h=!0,console.log(`Backup loaded with ${m.length} movies.`)}function E(){try{const a={movies_info:i.movies.map(e=>({movies_id:e.id,movies_name:e.title,movies_img:e.imageUrl,movies_href:e.link,movies_category:e.category,movies_hidden:e.hidden,dateAdded:e.dateAdded,isFavorite:e.isFavorite})),settings:i.settings,lastSaved:new Date().toISOString()},n=JSON.stringify(a);localStorage.setItem("app_database",n),console.log("Data saved to localStorage.")}catch(a){console.error("Error saving data:",a),alert("حدث خطأ أثناء حفظ البيانات")}}function b(a){try{return new URL(a).hostname.replace("www.","")}catch{return"unknown"}}function B(){const a=document.getElementById("searchInput");a.addEventListener("input",()=>{const n=a.value.toLowerCase().trim();n.length<2||i.movies.filter(e=>e.title.toLowerCase().includes(n)&&!e.hidden).slice(0,5)})}function f(){const a=document.getElementById("moviesContainer");a.innerHTML="";let n=i.movies.filter(c=>!c.hidden);const e=document.getElementById("sortBy").value,o=document.getElementById("siteSort").value;e==="site"&&o&&(n=n.filter(c=>c.site===o)),n=D(n,e);const t=(i.currentPage-1)*i.itemsPerPage,s=t+i.itemsPerPage;n.slice(t,s).forEach((c,u)=>{const g=A(c,u);a.appendChild(g)}),T(n.length);const l=document.getElementById("loadMoreCounter");if(l&&h){const c=m.length,u=n.length;l.textContent=`${u} / ${c}`}}function A(a,n){const e=document.createElement("div");return e.className="movie-card",e.innerHTML=`
        <div class="movie-poster-container">
            <span class="movie-number">${(i.currentPage-1)*i.itemsPerPage+n+1}</span>
            <span class="movie-site" title="${a.site}">${a.site}</span>
            <img src="${a.imageUrl}" alt="${a.title}" class="movie-poster" 
                 onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
            <div class="movie-title-overlay">
                <h3 class="movie-title" title="${a.title}">${a.title}</h3>
            </div>
        </div>
        <div class="movie-info">
            <div class="movie-actions">
                <button class="btn-favorite ${a.isFavorite?"active":""}" 
                        onclick="toggleFavorite('${a.id}')" title="إضافة للمفضلة">⭐</button>
                <button class="btn-edit" onclick="openEditModal('${a.id}')" title="تعديل">⋮</button>
            </div>
        </div>
    `,e.querySelector(".movie-title").addEventListener("mouseup",function(){const t=window.getSelection().toString().trim();t&&navigator.clipboard.writeText(t).then(()=>{console.log("تم نسخ النص: "+t)}).catch(s=>{console.error("فشل النسخ:",s)})}),e.addEventListener("click",t=>{!t.target.closest(".movie-actions")&&!t.target.closest(".movie-title")&&window.open(a.link,"_blank")}),e}function D(a,n){const e=[...a];switch(n){case"date_asc":return e.sort((o,t)=>new Date(o.dateAdded)-new Date(t.dateAdded));case"date_desc":return e.sort((o,t)=>new Date(t.dateAdded)-new Date(o.dateAdded));case"name_asc":return e.sort((o,t)=>o.title.localeCompare(t.title,"ar"));case"name_desc":return e.sort((o,t)=>t.title.localeCompare(o.title,"ar"));case"site":return e.sort((o,t)=>o.site.localeCompare(t.site));default:return e}}function p(){["all","old_arabic","new_arabic","series","foreign1","foreign2","foreign3","franchises","indian","asian","horror","stars","various","sites","selected1","selected2","favorites1","favorites2","r1","r2","s1","s2","x1","xsites","selected_r","selected_s","selected_x","thursday_night"].forEach(n=>{const e=n==="all"?i.movies.filter(t=>!t.hidden).length:i.movies.filter(t=>t.category===n&&!t.hidden).length,o=document.getElementById(`counter-${n}`);o&&(o.textContent=e)})}function T(a){const n=Math.ceil(a/i.itemsPerPage),e=document.getElementById("pageNumbers");e.innerHTML="";const o=Math.max(1,i.currentPage-5),t=Math.min(n,o+9);for(let s=o;s<=t;s++){const r=document.createElement("button");r.className=`btn-page ${s===i.currentPage?"active":""}`,r.textContent=s,r.onclick=()=>$(s),e.appendChild(r)}}function $(a){const n=i.movies.filter(t=>!t.hidden).length,e=Math.ceil(n/i.itemsPerPage);a==="prev"?i.currentPage=Math.max(1,i.currentPage-1):a==="next"?i.currentPage=Math.min(e,i.currentPage+1):a==="last"?i.currentPage=e:typeof a=="number"&&(i.currentPage=a),f();const o=document.getElementById("moviesContainer");o&&o.scrollIntoView({behavior:"smooth",block:"start"})}function F(){const a=document.getElementById("zoomToggle"),n=document.querySelector(".zoom-control");a.addEventListener("click",()=>{n.classList.toggle("visible")})}function v(){const a=["bulkAddSection","manualMovieSection","selectedSection","targetSection","targetSectionForSite"],n=[{value:"all",label:"جميع الأفلام والمسلسلات"},{value:"old_arabic",label:"الأفلام العربية القديمة"},{value:"new_arabic",label:"الأفلام العربية الجديدة"},{value:"series",label:"المسلسلات"},{value:"foreign1",label:"الأفلام الأجنبية 1"},{value:"foreign2",label:"الأفلام الأجنبية 2"},{value:"foreign3",label:"الأفلام الأجنبية 3"},{value:"franchises",label:"سلاسل الأفلام"},{value:"indian",label:"الأفلام الهندية"},{value:"asian",label:"الأفلام الآسيوية"},{value:"horror",label:"أفلام الرعب"},{value:"stars",label:"أفلام النجوم"},{value:"various",label:"الأفلام المتنوعة"},{value:"selected1",label:"أفلام مختارة 1"},{value:"selected2",label:"أفلام مختارة 2"},{value:"favorites1",label:"المفضلة 1"},{value:"favorites2",label:"المفضلة 2"}];i.accessMode==="full"&&n.push({value:"r1",label:"الأفلام R1"},{value:"r2",label:"الأفلام R2"},{value:"s1",label:"الأفلام S1"},{value:"s2",label:"الأفلام S2"},{value:"x1",label:"الأفلام X1"},{value:"xsites",label:"X SITES"},{value:"selected_r",label:"أفلام مختارة R"},{value:"selected_s",label:"أفلام مختارة S"},{value:"selected_x",label:"أفلام مختارة X"},{value:"thursday_night",label:"قسم ليلة الخميس"}),a.forEach(r=>{const l=document.getElementById(r);l&&(l.innerHTML='<option value="">اختر القسم</option>',n.forEach(c=>{const u=document.createElement("option");u.value=c.value,u.textContent=c.label,l.appendChild(u)}))});const e=document.getElementById("targetSection");e&&e.innerHTML===""&&(e.innerHTML='<option value="">اختر القسم</option>',n.forEach(r=>{const l=document.createElement("option");l.value=r.value,l.textContent=r.label,e.appendChild(l)}));const o=document.getElementById("targetSectionForSite");o&&o.innerHTML===""&&(o.innerHTML='<option value="">اختر القسم</option>',n.forEach(r=>{const l=document.createElement("option");l.value=r.value,l.textContent=r.label,o.appendChild(l)}));const t=[...new Set(i.movies.map(r=>r.site))].sort(),s=document.getElementById("selectedSite");s&&(s.innerHTML='<option value="">اختر الموقع</option>',t.forEach(r=>{const l=document.createElement("option");l.value=r,l.textContent=r,s.appendChild(l)}))}function N(){const a=document.getElementById("quickAddLink");a.addEventListener("dragover",n=>{n.preventDefault(),a.style.borderColor="var(--accent-primary)"}),a.addEventListener("dragleave",n=>{a.style.borderColor=""}),a.addEventListener("drop",n=>{n.preventDefault(),a.style.borderColor="";const e=n.dataTransfer.getData("text/plain");e&&e.startsWith("http")&&(a.value=e)})}function O(){const a=document.querySelector(".app-header");window.addEventListener("scroll",()=>{(window.pageYOffset||document.documentElement.scrollTop)>100?a.style.transform="translateY(-100%)":a.style.transform="translateY(0)"})}
